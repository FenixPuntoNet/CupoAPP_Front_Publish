<!DOCTYPE html>
<html>
<head>
    <title>Test Compresi√≥n de Im√°genes</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; margin: 20px 0; }
        .result { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        img { max-width: 200px; max-height: 200px; margin: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test de Compresi√≥n de Im√°genes</h1>
        <p>Esta herramienta te permite probar la compresi√≥n de im√°genes antes de subirlas.</p>
        
        <div class="upload-area">
            <input type="file" id="fileInput" accept="image/*" />
            <p>Selecciona una imagen para probar la compresi√≥n</p>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        // Funci√≥n de compresi√≥n (copia de la implementaci√≥n)
        function compressImage(file, maxSizeKB = 450, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // Calcular nuevas dimensiones manteniendo proporci√≥n
                    let { width, height } = img;
                    const maxDimension = 1200; // M√°ximo 1200px en cualquier lado
                    
                    if (width > height) {
                        if (width > maxDimension) {
                            height = (height * maxDimension) / width;
                            width = maxDimension;
                        }
                    } else {
                        if (height > maxDimension) {
                            width = (width * maxDimension) / height;
                            height = maxDimension;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Dibujar imagen redimensionada
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convertir a base64 con calidad espec√≠fica
                    let currentQuality = quality;
                    let result = canvas.toDataURL('image/jpeg', currentQuality);
                    
                    // Reducir calidad hasta alcanzar el tama√±o deseado
                    while (result.length > maxSizeKB * 1024 * 1.37 && currentQuality > 0.1) { // 1.37 factor base64
                        currentQuality -= 0.1;
                        result = canvas.toDataURL('image/jpeg', currentQuality);
                    }
                    
                    console.log(`üìä Image compressed: ${Math.round(file.size / 1024)}KB ‚Üí ${Math.round(result.length / 1024)}KB (quality: ${currentQuality.toFixed(1)})`);
                    resolve({
                        base64: result,
                        originalSize: file.size,
                        compressedSize: result.length,
                        quality: currentQuality,
                        dimensions: { width, height }
                    });
                };
                
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>üîÑ Procesando imagen...</p>';

            try {
                // Informaci√≥n del archivo original
                const originalInfo = {
                    name: file.name,
                    size: Math.round(file.size / 1024),
                    type: file.type
                };

                console.log('üìÅ Original file:', originalInfo);

                // Comprimir imagen
                const compressed = await compressImage(file, 450, 0.8);
                
                const compressionRatio = ((compressed.originalSize - compressed.compressedSize) / compressed.originalSize * 100).toFixed(1);

                resultsDiv.innerHTML = `
                    <div class="result success">
                        <h3>‚úÖ Compresi√≥n Exitosa</h3>
                        <p><strong>Archivo Original:</strong></p>
                        <ul>
                            <li>Nombre: ${originalInfo.name}</li>
                            <li>Tama√±o: ${originalInfo.size}KB</li>
                            <li>Tipo: ${originalInfo.type}</li>
                        </ul>
                        
                        <p><strong>Archivo Comprimido:</strong></p>
                        <ul>
                            <li>Tama√±o: ${Math.round(compressed.compressedSize / 1024)}KB</li>
                            <li>Calidad: ${(compressed.quality * 100).toFixed(0)}%</li>
                            <li>Dimensiones: ${compressed.dimensions.width} x ${compressed.dimensions.height}px</li>
                            <li>Reducci√≥n: ${compressionRatio}%</li>
                        </ul>
                        
                        <p><strong>Vista Previa:</strong></p>
                        <div>
                            <img src="${URL.createObjectURL(file)}" alt="Original" title="Original" />
                            <img src="${compressed.base64}" alt="Comprimida" title="Comprimida" />
                        </div>
                        <p><em>Izquierda: Original, Derecha: Comprimida</em></p>
                        
                        <p><strong>Base64 Size Check:</strong> ${compressed.compressedSize < 450 * 1024 * 1.37 ? '‚úÖ Dentro del l√≠mite' : '‚ùå Excede el l√≠mite'}</p>
                    </div>
                `;

            } catch (error) {
                console.error('‚ùå Compression error:', error);
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Error de Compresi√≥n</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
