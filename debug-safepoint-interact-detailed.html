<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” DEBUG: SafePoint Interact Endpoint</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: #e11d48; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #dcfce7; border-color: #16a34a; }
        .error { background: #fef2f2; border-color: #dc2626; }
        .warning { background: #fefce8; border-color: #ca8a04; }
        .info { background: #eff6ff; border-color: #2563eb; }
        .code { background: #f4f4f4; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; margin: 10px 0; }
        .log-item { margin: 5px 0; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .log-success { background: #dcfce7; }
        .log-error { background: #fef2f2; }
        .log-info { background: #eff6ff; }
        .log-warning { background: #fefce8; }
        button { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #1d4ed8; }
        .btn-danger { background: #dc2626; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-success { background: #16a34a; }
        .btn-success:hover { background: #15803d; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
        .status-online { background: #16a34a; }
        .status-offline { background: #dc2626; }
        .status-loading { background: #ca8a04; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” DEBUG: SafePoint Interact Endpoint - DIAGNÃ“STICO DETALLADO</h1>
            <p><strong>Objetivo:</strong> Diagnosticar el problema con el upsert/onConflict en /safepoints/interact</p>
        </div>

        <div class="section info">
            <h3>ğŸ“‹ PROBLEMA IDENTIFICADO</h3>
            <div class="code">
âŒ PROBLEMA: El endpoint /safepoints/interact estÃ¡ fallando con error 500
ğŸ” CAUSA PROBABLE: onConflict con constraint inexistente
ğŸ› ï¸ LÃNEA PROBLEMÃTICA: onConflict: 'safepoint_id,user_id,trip_id,interaction_type'
âœ… SOLUCIÃ“N: Actualizar el upsert para usar la nueva estructura de tabla
            </div>
        </div>

        <div class="section" id="backend-status">
            <h3><span class="status-indicator status-loading"></span>Estado del Backend</h3>
            <div id="backend-info">Verificando conectividad...</div>
        </div>

        <div class="section">
            <h3>ğŸ§ª TESTS DE ENDPOINT</h3>
            
            <div class="grid">
                <div>
                    <h4>Test 1: Request VÃ¡lido con trip_id NULL</h4>
                    <button onclick="testValidRequest()" class="btn-success">ğŸ§ª Test Request VÃ¡lido</button>
                    <div id="test1-result" class="log-container"></div>
                </div>
                
                <div>
                    <h4>Test 2: Request con trip_id Real</h4>
                    <button onclick="testRealTripRequest()" class="btn-success">ğŸ§ª Test Trip Real</button>
                    <div id="test2-result" class="log-container"></div>
                </div>
            </div>

            <div class="grid">
                <div>
                    <h4>Test 3: Request MÃ­nimo</h4>
                    <button onclick="testMinimalRequest()" class="btn-success">ğŸ§ª Test MÃ­nimo</button>
                    <div id="test3-result" class="log-container"></div>
                </div>
                
                <div>
                    <h4>Test 4: DiagnÃ³stico de Error</h4>
                    <button onclick="testErrorDiagnosis()" class="btn-danger">ğŸ” DiagnÃ³stico de Error</button>
                    <div id="test4-result" class="log-container"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ“Š LOGS DETALLADOS</h3>
            <div id="logs-container" style="max-height: 400px; overflow-y: auto;"></div>
            <button onclick="clearLogs()" class="btn-danger">ğŸ—‘ï¸ Limpiar Logs</button>
        </div>

        <div class="section">
            <h3>ğŸ› ï¸ ESTRUCTURA ESPERADA vs ACTUAL</h3>
            <div class="grid">
                <div>
                    <h4>âœ… Estructura Esperada (Nueva Tabla)</h4>
                    <div class="code">{
  "safepoint_id": 123,
  "interaction_type": "pickup_selection",
  "trip_id": null,
  "interaction_data": {
    "timestamp": "2025-08-10T...",
    "user_context": "frontend_interaction",
    "selection_details": {
      "is_draft": true,
      "preference_level": "preferred"
    }
  }
}</div>
                </div>
                
                <div>
                    <h4>âŒ Estructura ProblemÃ¡tica (Backend)</h4>
                    <div class="code">// PROBLEMA EN BACKEND:
onConflict: 'safepoint_id,user_id,trip_id,interaction_type'

// â†“ Este constraint ya no existe despuÃ©s de la migraciÃ³n
// â†“ Causando error 500 en el upsert</div>
                </div>
            </div>
        </div>

        <div class="section warning">
            <h3>âš ï¸ POSIBLES SOLUCIONES</h3>
            <div class="code">
1. ğŸ”§ BACKEND: Eliminar el onConflict problemÃ¡tico
   - Quitar: onConflict: 'safepoint_id,user_id,trip_id,interaction_type'
   - Usar: .insert() simple sin upsert

2. ğŸ”§ BACKEND: Usar onConflict correcto
   - Crear nuevo constraint Ãºnico si es necesario
   - O usar onConflict: ['id'] si existe primary key

3. ğŸ”§ BACKEND: Manejar duplicados en lÃ³gica
   - Verificar existencia antes de insertar
   - Update si existe, insert si no existe

4. ğŸ”§ FRONTEND: Implementar retry logic
   - Reintentar request si falla
   - Fallback a almacenamiento local
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://cupo-backend.fly.dev';
        
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const logContainer = document.getElementById('logs-container');
            
            const logClass = `log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            const logElement = document.createElement('div');
            logElement.className = `log-item ${logClass}`;
            logElement.textContent = logMessage;
            
            if (container) {
                container.appendChild(logElement);
            }
            
            logContainer.appendChild(logElement.cloneNode(true));
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs-container').innerHTML = '';
            document.querySelectorAll('.log-container').forEach(container => {
                container.innerHTML = '';
            });
        }

        async function checkBackendStatus() {
            try {
                log('backend-info', 'ğŸ” Verificando conectividad del backend...', 'info');
                
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const statusIndicator = document.querySelector('#backend-status .status-indicator');
                const statusInfo = document.getElementById('backend-info');
                
                if (response.ok) {
                    statusIndicator.className = 'status-indicator status-online';
                    statusInfo.innerHTML = `âœ… Backend Online - Status: ${response.status}`;
                    log('backend-info', `âœ… Backend conectado exitosamente`, 'success');
                } else {
                    statusIndicator.className = 'status-indicator status-offline';
                    statusInfo.innerHTML = `âŒ Backend Error - Status: ${response.status}`;
                    log('backend-info', `âŒ Backend error: ${response.status}`, 'error');
                }
            } catch (error) {
                const statusIndicator = document.querySelector('#backend-status .status-indicator');
                const statusInfo = document.getElementById('backend-info');
                
                statusIndicator.className = 'status-indicator status-offline';
                statusInfo.innerHTML = `âŒ Backend Offline - ${error.message}`;
                log('backend-info', `âŒ Error de conectividad: ${error.message}`, 'error');
            }
        }

        async function testValidRequest() {
            try {
                log('test1-result', 'ğŸ§ª INICIANDO: Test con request vÃ¡lido (trip_id = NULL)', 'info');
                
                const testData = {
                    safepoint_id: 1,
                    interaction_type: 'pickup_selection',
                    trip_id: null,
                    interaction_data: {
                        timestamp: new Date().toISOString(),
                        user_context: 'frontend_debug',
                        selection_details: {
                            is_draft: true,
                            preference_level: 'preferred'
                        }
                    },
                    negotiation_round: 1
                };

                log('test1-result', `ğŸ“¤ Enviando: ${JSON.stringify(testData, null, 2)}`, 'info');

                const response = await fetch(`${API_BASE}/safepoints/interact`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer debug-token' // Token de prueba
                    },
                    body: JSON.stringify(testData)
                });

                const responseText = await response.text();
                log('test1-result', `ğŸ“¥ Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                log('test1-result', `ğŸ“¥ Response Body: ${responseText}`, response.ok ? 'success' : 'error');

                if (!response.ok) {
                    log('test1-result', `âŒ ERROR DETECTADO: Status ${response.status}`, 'error');
                    
                    if (response.status === 500 && responseText.includes('constraint')) {
                        log('test1-result', `ğŸ¯ CONFIRMED: El problema es el onConflict constraint`, 'error');
                    }
                } else {
                    log('test1-result', `âœ… REQUEST EXITOSO: Backend funcionando correctamente`, 'success');
                }

            } catch (error) {
                log('test1-result', `âŒ Error en test: ${error.message}`, 'error');
            }
        }

        async function testRealTripRequest() {
            try {
                log('test2-result', 'ğŸ§ª INICIANDO: Test con trip_id real', 'info');
                
                const testData = {
                    safepoint_id: 1,
                    interaction_type: 'pickup_selection',
                    trip_id: 12345,
                    interaction_data: {
                        timestamp: new Date().toISOString(),
                        user_context: 'frontend_debug_real_trip'
                    }
                };

                const response = await fetch(`${API_BASE}/safepoints/interact`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer debug-token'
                    },
                    body: JSON.stringify(testData)
                });

                const responseText = await response.text();
                log('test2-result', `ğŸ“¥ Response: ${response.status} - ${responseText}`, response.ok ? 'success' : 'error');

            } catch (error) {
                log('test2-result', `âŒ Error: ${error.message}`, 'error');
            }
        }

        async function testMinimalRequest() {
            try {
                log('test3-result', 'ğŸ§ª INICIANDO: Test con datos mÃ­nimos', 'info');
                
                const testData = {
                    safepoint_id: 1,
                    interaction_type: 'pickup_selection'
                };

                const response = await fetch(`${API_BASE}/safepoints/interact`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });

                const responseText = await response.text();
                log('test3-result', `ğŸ“¥ Response: ${response.status} - ${responseText}`, response.ok ? 'success' : 'error');

            } catch (error) {
                log('test3-result', `âŒ Error: ${error.message}`, 'error');
            }
        }

        async function testErrorDiagnosis() {
            try {
                log('test4-result', 'ğŸ” INICIANDO: DiagnÃ³stico detallado de error', 'warning');
                
                // Test mÃºltiples escenarios para identificar el problema exacto
                const scenarios = [
                    {
                        name: 'Sin trip_id',
                        data: { safepoint_id: 1, interaction_type: 'pickup_selection' }
                    },
                    {
                        name: 'Con trip_id NULL explÃ­cito',
                        data: { safepoint_id: 1, interaction_type: 'pickup_selection', trip_id: null }
                    },
                    {
                        name: 'Con trip_id vÃ¡lido',
                        data: { safepoint_id: 1, interaction_type: 'pickup_selection', trip_id: 999 }
                    },
                    {
                        name: 'SafePoint inexistente',
                        data: { safepoint_id: 99999, interaction_type: 'pickup_selection' }
                    }
                ];

                for (const scenario of scenarios) {
                    log('test4-result', `ğŸ§ª Testing: ${scenario.name}`, 'info');
                    
                    try {
                        const response = await fetch(`${API_BASE}/safepoints/interact`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(scenario.data)
                        });

                        const responseText = await response.text();
                        log('test4-result', `   â””â”€ ${scenario.name}: ${response.status} - ${responseText.substring(0, 100)}`, response.ok ? 'success' : 'error');
                        
                        // AnÃ¡lisis especÃ­fico del error
                        if (!response.ok && responseText.includes('constraint')) {
                            log('test4-result', `   â””â”€ ğŸ¯ CONSTRAINT ERROR DETECTED en: ${scenario.name}`, 'error');
                        }
                        
                    } catch (error) {
                        log('test4-result', `   â””â”€ ${scenario.name}: Network Error - ${error.message}`, 'error');
                    }
                    
                    // Delay entre tests
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                log('test4-result', 'ğŸ” DiagnÃ³stico completado', 'info');

            } catch (error) {
                log('test4-result', `âŒ Error en diagnÃ³stico: ${error.message}`, 'error');
            }
        }

        // Ejecutar verificaciÃ³n de estado al cargar
        document.addEventListener('DOMContentLoaded', () => {
            checkBackendStatus();
            
            log('logs-container', 'ğŸš€ DEBUG TOOL INICIADO - Listo para diagnosticar el problema del upsert', 'info');
            log('logs-container', 'ğŸ¯ OBJETIVO: Identificar y resolver el error de onConflict constraint', 'warning');
        });
    </script>
</body>
</html>
