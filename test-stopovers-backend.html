<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Backend Stopovers Migration</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .logs { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Backend Stopovers Migration</h1>
        
        <div class="section info">
            <h3>üìä Estado de la Prueba</h3>
            <p>Esta p√°gina prueba si el endpoint <code>/paradas/update-stopovers-trip-id</code> est√° funcionando correctamente en el backend.</p>
            <p><strong>Backend URL:</strong> <span id="backendUrl">Detectando...</span></p>
            <p><strong>Estado:</strong> <span id="status">Iniciando...</span></p>
        </div>

        <div class="section">
            <h3>üîß Acciones de Prueba</h3>
            <button onclick="testBackendConnection()">üîó Probar Conexi√≥n Backend</button>
            <button onclick="testGetPendingStopovers()">üìã Obtener Stopovers Pendientes</button>
            <button onclick="testUpdateStopoversTripId()">üîÑ Probar Migraci√≥n de Stopovers</button>
            <button onclick="testAuthEndpoint()">üîê Probar Autenticaci√≥n</button>
            <button onclick="clearLogs()">üßπ Limpiar Logs</button>
        </div>

        <div class="section">
            <h3>üìù Logs de Prueba</h3>
            <div id="logs" class="logs"></div>
        </div>

        <div class="section">
            <h3>üìà Resultados</h3>
            <div id="results"></div>
        </div>
    </div>

    <script>
        // Configuraci√≥n del backend
        const BACKEND_URL = 'http://localhost:5000/api'; // Ajustar seg√∫n tu configuraci√≥n
        
        // Funci√≥n para logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.style.margin = '5px 0';
            logEntry.style.padding = '5px';
            logEntry.style.borderRadius = '3px';
            
            switch(type) {
                case 'success':
                    logEntry.style.backgroundColor = '#d4edda';
                    logEntry.style.color = '#155724';
                    break;
                case 'error':
                    logEntry.style.backgroundColor = '#f8d7da';
                    logEntry.style.color = '#721c24';
                    break;
                case 'warning':
                    logEntry.style.backgroundColor = '#fff3cd';
                    logEntry.style.color = '#856404';
                    break;
                default:
                    logEntry.style.backgroundColor = '#e9ecef';
                    logEntry.style.color = '#495057';
            }
            
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('results').innerHTML = '';
        }

        function updateStatus(status, type = 'info') {
            const statusSpan = document.getElementById('status');
            statusSpan.textContent = status;
            statusSpan.className = type;
        }

        // Funci√≥n helper para hacer requests al backend
        async function makeBackendRequest(endpoint, options = {}) {
            const url = `${BACKEND_URL}${endpoint}`;
            
            // Token de prueba - necesitar√°s uno v√°lido para pruebas reales
            const token = localStorage.getItem('auth_token') || 'TEST_TOKEN';
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };

            const finalOptions = { ...defaultOptions, ...options };
            
            log(`üîÑ Haciendo request a: ${url}`, 'info');
            log(`üìù Opciones: ${JSON.stringify(finalOptions, null, 2)}`, 'info');
            
            try {
                const response = await fetch(url, finalOptions);
                const data = await response.json();
                
                log(`‚úÖ Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`üìÑ Response Data: ${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');
                
                return { success: response.ok, status: response.status, data };
            } catch (error) {
                log(`‚ùå Request Error: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // Test de conexi√≥n al backend
        async function testBackendConnection() {
            log('üîó Probando conexi√≥n al backend...', 'info');
            updateStatus('Probando conexi√≥n...', 'info');
            
            try {
                const result = await makeBackendRequest('/health', { method: 'GET' });
                
                if (result.success) {
                    log('‚úÖ Conexi√≥n al backend exitosa', 'success');
                    updateStatus('Backend conectado', 'success');
                } else {
                    log(`‚ùå Error de conexi√≥n: ${result.status}`, 'error');
                    updateStatus('Error de conexi√≥n', 'error');
                }
            } catch (error) {
                log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                updateStatus('Error de conexi√≥n', 'error');
            }
        }

        // Test para obtener stopovers pendientes
        async function testGetPendingStopovers() {
            log('üìã Probando obtener stopovers pendientes...', 'info');
            updateStatus('Obteniendo stopovers...', 'info');
            
            const result = await makeBackendRequest('/paradas/pending-stopovers', { method: 'GET' });
            
            if (result.success) {
                log('‚úÖ Stopovers pendientes obtenidos correctamente', 'success');
                updateStatus('Stopovers obtenidos', 'success');
                
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = `
                    <div class="section success">
                        <h4>üìã Stopovers Pendientes Encontrados</h4>
                        <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    </div>
                `;
            } else {
                log(`‚ùå Error obteniendo stopovers: ${result.error || result.status}`, 'error');
                updateStatus('Error obteniendo stopovers', 'error');
            }
        }

        // Test para migrar stopovers
        async function testUpdateStopoversTripId() {
            log('üîÑ Probando migraci√≥n de stopovers...', 'info');
            updateStatus('Probando migraci√≥n...', 'info');
            
            // Datos de prueba
            const testData = {
                stopover_ids: [1, 2, 3], // IDs de prueba
                trip_id: 999 // Trip ID de prueba
            };
            
            const result = await makeBackendRequest('/paradas/update-stopovers-trip-id', {
                method: 'POST',
                body: JSON.stringify(testData)
            });
            
            if (result.success) {
                log('‚úÖ Migraci√≥n de stopovers exitosa', 'success');
                updateStatus('Migraci√≥n exitosa', 'success');
                
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = `
                    <div class="section success">
                        <h4>‚úÖ Migraci√≥n de Stopovers Exitosa</h4>
                        <p><strong>Stopovers migrados:</strong> ${result.data.updated_count || 0}</p>
                        <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    </div>
                `;
            } else {
                log(`‚ùå Error en migraci√≥n: ${result.error || result.status}`, 'error');
                updateStatus('Error en migraci√≥n', 'error');
                
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = `
                    <div class="section error">
                        <h4>‚ùå Error en Migraci√≥n de Stopovers</h4>
                        <p><strong>Status:</strong> ${result.status}</p>
                        <p><strong>Error:</strong> ${result.error || 'Error desconocido'}</p>
                        <pre>${JSON.stringify(result.data || {}, null, 2)}</pre>
                    </div>
                `;
            }
        }

        // Test de autenticaci√≥n
        async function testAuthEndpoint() {
            log('üîê Probando autenticaci√≥n...', 'info');
            updateStatus('Probando auth...', 'info');
            
            const result = await makeBackendRequest('/auth/verify', { method: 'GET' });
            
            if (result.success) {
                log('‚úÖ Autenticaci√≥n v√°lida', 'success');
                updateStatus('Auth v√°lido', 'success');
            } else {
                log(`‚ö†Ô∏è Problema de autenticaci√≥n: ${result.status}`, 'warning');
                updateStatus('Auth issue', 'warning');
                
                if (result.status === 401) {
                    log('üí° Necesitas un token v√°lido para las pruebas completas', 'warning');
                }
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('backendUrl').textContent = BACKEND_URL;
            log('üöÄ Test de Backend Stopovers iniciado', 'info');
            updateStatus('Listo para probar', 'info');
            
            // Auto-test de conexi√≥n
            setTimeout(testBackendConnection, 1000);
        });
    </script>
</body>
</html>
